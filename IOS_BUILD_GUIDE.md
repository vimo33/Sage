# iOS Build Guide for Sage AI

## Summary of Fixes Applied

The iOS build had several issues that have been resolved:

### 1. CocoaPods UTF-8 Encoding Issue
**Problem**: CocoaPods requires UTF-8 encoding but the terminal wasn't configured properly.
**Solution**: All pod commands must be run with `export LANG=en_US.UTF-8` set.

### 2. Node.js Path Mismatch
**Problem**: Xcode was looking for Node.js at `/opt/homebrew/Cellar/node/24.10.0/bin/node` but the system has v25.2.1 installed.
**Solution**: Updated `ios/.xcode.env.local` to use the symlink path `/opt/homebrew/bin/node` which automatically points to the current version.

### 3. Missing React Native Codegen Files
**Problem**: Build input files for ReactCodegen were not being generated properly.
**Solution**: Regenerated by running `pod install` with the correct Node.js path configured.

### 4. expo-media-library Swift Compilation Error
**Problem**: expo-media-library v18.2.1 was using an outdated ExpoModulesCore API (`Constant` vs `Constants`).
**Solution**: Downgraded expo-media-library from 18.2.1 to 17.0.6 which is compatible with Expo SDK 52.

## How to Run the iOS App

### Complete Workflow (Two Terminal Windows)

**Terminal 1 - Start Metro Bundler:**
```bash
npx expo start --clear
```
Keep this running - it will show "Waiting on http://localhost:8081"

**Terminal 2 - Build and Launch App:**
```bash
export LANG=en_US.UTF-8
npm run ios -- --device "iPhone 17"
```

### After Launch:
1. The app will open showing "Sage - Development Build"
2. You'll see your development server listed (e.g., "Sage on Vimos-MacBook-Air.local")
3. Tap on the server entry to load your React Native app
4. The app will connect to Metro and load your JavaScript bundle

### Option 2: Using the helper script
```bash
# Terminal 1 - Start Metro
npx expo start --clear

# Terminal 2 - Use helper script
./run-ios.sh
```

This script automatically:
- Sets UTF-8 encoding
- Cleans build artifacts
- Installs CocoaPods dependencies
- Lists available simulators
- Builds and runs on iPhone 17 simulator

## Build Environment Details

- **Xcode Version**: 26.2 (Build 17C52)
- **Node.js Version**: v25.2.1
- **CocoaPods Version**: 1.16.2
- **Expo SDK Version**: ~52.0.48
- **React Native Version**: 0.76.5
- **iOS Deployment Target**: 15.1
- **Simulator**: iPhone 17

## Key Files Modified

1. **ios/.xcode.env.local** - Updated Node.js binary path
2. **package.json** - Updated expo-media-library dependency constraint
3. **run-ios.sh** - Created helper script for easier builds

## Build Warnings (Non-Critical)

The following warnings appear but do not affect functionality:
- Script phase warnings about outputs not specified (React Native codegen checks)
- Duplicate C++ library warnings during linking
- expo-media-library header guard warnings (cosmetic, doesn't affect runtime)

## Troubleshooting

### If pod install fails with UTF-8 error:
```bash
export LANG=en_US.UTF-8
cd ios && pod install && cd ..
```

### If build fails with Node.js not found:
Check that `ios/.xcode.env.local` contains:
```bash
export NODE_BINARY=/opt/homebrew/bin/node
```

### If codegen files are missing:
```bash
cd ios
export LANG=en_US.UTF-8
pod install --repo-update
cd ..
```

### To clean and rebuild:
```bash
rm -rf ~/Library/Developer/Xcode/DerivedData
rm -rf ios/build
export LANG=en_US.UTF-8
npm run ios -- --device "iPhone 17"
```

## Build Status

✅ **Build Successful**
✅ **App Installed on Simulator**
✅ **No Critical Errors**

The app builds successfully and launches on the iPhone 17 simulator.
